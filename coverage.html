
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>verifier: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/sakuhanight/gopier/internal/verifier/verifier.go (79.9%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package verifier

import (
        "context"
        "fmt"
        "os"
        "path/filepath"
        "sync"
        "time"

        "github.com/sakuhanight/gopier/internal/database"
        "github.com/sakuhanight/gopier/internal/filter"
        "github.com/sakuhanight/gopier/internal/hasher"
        "github.com/sakuhanight/gopier/internal/stats"
)

// ProgressCallback は進捗報告のためのコールバック関数型
type ProgressCallback func(current, total int64, currentFile string)

// Options は検証オプションを表す構造体
type Options struct {
        BufferSize       int           // ハッシュ計算のバッファサイズ
        Recursive        bool          // 再帰的に検証するかどうか
        HashAlgorithm    string        // ハッシュアルゴリズム
        ProgressInterval time.Duration // 進捗報告の間隔
        MaxConcurrent    int           // 最大並行検証数
        FailFast         bool          // 最初のエラーで停止するかどうか
        IgnoreMissing    bool          // 存在しないファイルを無視するかどうか
        IgnoreExtra      bool          // 余分なファイルを無視するかどうか
}

// DefaultOptions はデフォルトのオプションを返す
func DefaultOptions() Options <span class="cov8" title="1">{
        return Options{
                BufferSize:       32 * 1024 * 1024, // 32MB
                Recursive:        true,
                HashAlgorithm:    string(hasher.SHA256),
                ProgressInterval: time.Second * 1,
                MaxConcurrent:    4,
                FailFast:         false,
                IgnoreMissing:    false,
                IgnoreExtra:      false,
        }
}</span>

// VerificationResult は検証結果を表す構造体
type VerificationResult struct {
        Path         string    // ファイルパス（相対パス）
        SourceExists bool      // ソースファイルが存在するかどうか
        DestExists   bool      // 宛先ファイルが存在するかどうか
        SizeMatch    bool      // サイズが一致するかどうか
        HashMatch    bool      // ハッシュが一致するかどうか
        SourceHash   string    // ソースファイルのハッシュ
        DestHash     string    // 宛先ファイルのハッシュ
        SourceSize   int64     // ソースファイルのサイズ
        DestSize     int64     // 宛先ファイルのサイズ
        SourceTime   time.Time // ソースファイルの更新時間
        DestTime     time.Time // 宛先ファイルの更新時間
        Error        error     // エラー情報
}

// Verifier はファイル検証処理を管理する構造体
type Verifier struct {
        sourceDir     string
        destDir       string
        options       Options
        stats         *stats.Stats
        filter        *filter.Filter
        hasher        *hasher.Hasher
        db            *database.SyncDB
        progressChan  chan string
        progressFunc  ProgressCallback
        wg            sync.WaitGroup
        semaphore     chan struct{}
        ctx           context.Context
        cancel        context.CancelFunc
        results       []VerificationResult
        resultsMutex  sync.Mutex
        errCount      int64
        errCountMutex sync.Mutex
}

// NewVerifier は新しいVerifierを作成する
func NewVerifier(sourceDir, destDir string, options Options, fileFilter *filter.Filter, syncDB *database.SyncDB) *Verifier <span class="cov8" title="1">{
        ctx, cancel := context.WithCancel(context.Background())

        // セマフォの初期化
        semaphore := make(chan struct{}, options.MaxConcurrent)

        // ハッシャーの初期化
        hashAlgo := hasher.Algorithm(options.HashAlgorithm)
        fileHasher := hasher.NewHasher(hashAlgo, options.BufferSize)

        return &amp;Verifier{
                sourceDir:    sourceDir,
                destDir:      destDir,
                options:      options,
                stats:        stats.NewStats(),
                filter:       fileFilter,
                hasher:       fileHasher,
                db:           syncDB,
                progressChan: make(chan string, 100),
                ctx:          ctx,
                cancel:       cancel,
                semaphore:    semaphore,
                results:      make([]VerificationResult, 0),
        }
}</span>

// SetProgressCallback は進捗報告のコールバック関数を設定する
func (v *Verifier) SetProgressCallback(callback ProgressCallback) <span class="cov8" title="1">{
        v.progressFunc = callback
}</span>

// GetStats は現在の統計情報を返す
func (v *Verifier) GetStats() *stats.Stats <span class="cov8" title="1">{
        return v.stats
}</span>

// Cancel は検証処理をキャンセルする
func (v *Verifier) Cancel() <span class="cov8" title="1">{
        v.cancel()
}</span>

// GetResults は検証結果を返す
func (v *Verifier) GetResults() []VerificationResult <span class="cov8" title="1">{
        return v.results
}</span>

// GetErrorCount はエラー数を返す
func (v *Verifier) GetErrorCount() int64 <span class="cov8" title="1">{
        v.errCountMutex.Lock()
        defer v.errCountMutex.Unlock()
        return v.errCount
}</span>

// addResult は検証結果を追加する
func (v *Verifier) addResult(result VerificationResult) <span class="cov8" title="1">{
        v.resultsMutex.Lock()
        defer v.resultsMutex.Unlock()
        v.results = append(v.results, result)

        // エラーカウントの更新
        if result.Error != nil || !result.HashMatch || !result.SourceExists || !result.DestExists </span><span class="cov8" title="1">{
                v.errCountMutex.Lock()
                v.errCount++
                v.errCountMutex.Unlock()

                // 即時エラー停止が有効な場合
                if v.options.FailFast </span><span class="cov8" title="1">{
                        v.cancel()
                }</span>
        }
}

// Verify はファイルの検証を行う
func (v *Verifier) Verify() error <span class="cov8" title="1">{
        // 同期セッションの開始
        var sessionID int64
        var err error
        if v.db != nil </span><span class="cov8" title="1">{
                sessionID, err = v.db.StartSyncSession()
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("同期セッション開始エラー: %w", err)
                }</span>
        }

        // 進捗報告ゴルーチンの開始
        <span class="cov8" title="1">if v.progressFunc != nil </span><span class="cov8" title="1">{
                go v.reportProgress()
        }</span>

        // ソースディレクトリの存在確認
        <span class="cov8" title="1">sourceInfo, err := os.Stat(v.sourceDir)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("ソースディレクトリの確認エラー: %w", err)
        }</span>

        // ソースがディレクトリの場合
        <span class="cov8" title="1">if sourceInfo.IsDir() </span><span class="cov8" title="1">{
                // ディレクトリの検証
                err = v.verifyDirectory(v.sourceDir, v.destDir)

                // 余分なファイルのチェック（IgnoreExtraがfalseの場合）
                if err == nil &amp;&amp; !v.options.IgnoreExtra </span><span class="cov8" title="1">{
                        err = v.checkExtraFiles(v.sourceDir, v.destDir)
                }</span>
        } else<span class="cov0" title="0"> {
                // 単一ファイルの検証
                destPath := filepath.Join(v.destDir, filepath.Base(v.sourceDir))
                _, err = v.verifyFile(v.sourceDir, destPath)
        }</span>

        // すべてのゴルーチンの完了を待つ
        <span class="cov8" title="1">v.wg.Wait()

        // チャンネルがまだ開いている場合のみ閉じる
        select </span>{
        case &lt;-v.progressChan:<span class="cov0" title="0"></span>
                // チャンネルは既に閉じられている
        default:<span class="cov8" title="1">
                close(v.progressChan)</span>
        }

        // 同期セッションの終了
        <span class="cov8" title="1">if v.db != nil </span><span class="cov8" title="1">{
                endErr := v.db.EndSyncSession(
                        sessionID,
                        0, // コピーされたファイル数
                        int(v.stats.GetSkippedCount()),
                        int(v.errCount),
                        0, // コピーされたバイト数
                )
                if endErr != nil </span><span class="cov0" title="0">{
                        // セッション終了エラーはログに記録するが、元のエラーを返す
                        fmt.Printf("同期セッション終了エラー: %v\n", endErr)
                }</span>
        }

        // エラーが発生したかどうかを返す
        <span class="cov8" title="1">if v.GetErrorCount() &gt; 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("%d 個のファイルで不一致が検出されました", v.GetErrorCount())
        }</span>

        <span class="cov8" title="1">return err</span>
}

// verifyDirectory はディレクトリを再帰的に検証する
func (v *Verifier) verifyDirectory(sourceDir, destDir string) error <span class="cov8" title="1">{
        // コンテキストのキャンセル確認
        select </span>{
        case &lt;-v.ctx.Done():<span class="cov8" title="1">
                return fmt.Errorf("検証処理がキャンセルされました")</span>
        default:<span class="cov8" title="1"></span>
        }

        // ソースディレクトリを開く
        <span class="cov8" title="1">entries, err := os.ReadDir(sourceDir)
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("ディレクトリ読み込みエラー: %w", err)
        }</span>

        // 宛先ディレクトリの存在確認
        <span class="cov8" title="1">if _, err := os.Stat(destDir); os.IsNotExist(err) </span><span class="cov8" title="1">{
                if !v.options.IgnoreMissing </span><span class="cov8" title="1">{
                        result := VerificationResult{
                                Path:         destDir,
                                SourceExists: true,
                                DestExists:   false,
                                Error:        fmt.Errorf("宛先ディレクトリが存在しません"),
                        }
                        v.addResult(result)
                }</span>
                <span class="cov8" title="1">return nil</span>
        }

        // 各エントリの処理
        <span class="cov8" title="1">for _, entry := range entries </span><span class="cov8" title="1">{
                sourcePath := filepath.Join(sourceDir, entry.Name())
                destPath := filepath.Join(destDir, entry.Name())

                // ディレクトリの場合
                if entry.IsDir() </span><span class="cov0" title="0">{
                        if !v.options.Recursive </span><span class="cov0" title="0">{
                                continue</span>
                        }

                        // 再帰的に検証
                        <span class="cov0" title="0">if err := v.verifyDirectory(sourcePath, destPath); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                        <span class="cov0" title="0">continue</span>
                }

                // ファイルの場合
                <span class="cov8" title="1">info, err := entry.Info()
                if err != nil </span><span class="cov0" title="0">{
                        v.stats.IncrementFailed()
                        result := VerificationResult{
                                Path:  sourcePath,
                                Error: fmt.Errorf("ファイル情報取得エラー: %w", err),
                        }
                        v.addResult(result)
                        continue</span>
                }

                // フィルタリング
                <span class="cov8" title="1">if v.filter != nil &amp;&amp; !v.filter.ShouldInclude(sourcePath) </span><span class="cov8" title="1">{
                        // ファイルをスキップ
                        v.stats.IncrementSkipped(info.Size())
                        continue</span>
                }

                // 非同期でファイルを検証
                <span class="cov8" title="1">v.wg.Add(1)
                go func(src, dst string) </span><span class="cov8" title="1">{
                        defer v.wg.Done()

                        // セマフォの取得
                        v.semaphore &lt;- struct{}{}
                        defer func() </span><span class="cov8" title="1">{
                                &lt;-v.semaphore
                        }</span>()

                        <span class="cov8" title="1">result, err := v.verifyFile(src, dst)
                        if err != nil </span><span class="cov0" title="0">{
                                fmt.Printf("ファイル検証エラー: %v\n", err)
                        }</span>

                        // 結果を追加
                        <span class="cov8" title="1">if result != nil </span><span class="cov8" title="1">{
                                v.addResult(*result)
                        }</span>
                }(sourcePath, destPath)
        }

        <span class="cov8" title="1">return nil</span>
}

// verifyFile は単一ファイルを検証する
func (v *Verifier) verifyFile(sourcePath, destPath string) (*VerificationResult, error) <span class="cov8" title="1">{
        // コンテキストのキャンセル確認
        select </span>{
        case &lt;-v.ctx.Done():<span class="cov0" title="0">
                return nil, fmt.Errorf("検証処理がキャンセルされました")</span>
        default:<span class="cov8" title="1"></span>
        }

        // 相対パスの計算
        <span class="cov8" title="1">relPath, err := filepath.Rel(v.sourceDir, sourcePath)
        if err != nil </span><span class="cov0" title="0">{
                relPath = filepath.Base(sourcePath)
        }</span>

        // 進捗報告
        <span class="cov8" title="1">if v.progressFunc != nil </span><span class="cov8" title="1">{
                select </span>{
                case v.progressChan &lt;- relPath:<span class="cov8" title="1"></span>
                        // 正常に送信
                default:<span class="cov8" title="1"></span>
                        // チャンネルが閉じられているか、バッファが一杯
                }
        }

        // 結果の初期化
        <span class="cov8" title="1">result := &amp;VerificationResult{
                Path:         relPath,
                SourceExists: true,
                DestExists:   true,
                SizeMatch:    false,
                HashMatch:    false,
        }

        // ソースファイルの情報を取得
        sourceInfo, err := os.Stat(sourcePath)
        if err != nil </span><span class="cov8" title="1">{
                result.SourceExists = false
                result.Error = fmt.Errorf("ソースファイル確認エラー: %w", err)
                return result, nil
        }</span>

        <span class="cov8" title="1">result.SourceSize = sourceInfo.Size()
        result.SourceTime = sourceInfo.ModTime()

        // 宛先ファイルの情報を取得
        destInfo, err := os.Stat(destPath)
        if err != nil </span><span class="cov8" title="1">{
                result.DestExists = false

                // 存在しないファイルを無視する場合
                if v.options.IgnoreMissing </span><span class="cov8" title="1">{
                        v.stats.IncrementSkipped(sourceInfo.Size())
                        return nil, nil
                }</span>

                <span class="cov8" title="1">result.Error = fmt.Errorf("宛先ファイル確認エラー: %w", err)

                // データベースに記録
                if v.db != nil </span><span class="cov0" title="0">{
                        fileInfo := database.FileInfo{
                                Path:         relPath,
                                Size:         sourceInfo.Size(),
                                ModTime:      sourceInfo.ModTime(),
                                Status:       database.StatusMismatch,
                                LastSyncTime: time.Now(),
                                LastError:    "宛先ファイルが存在しません",
                        }
                        v.db.AddFile(fileInfo)
                }</span>

                <span class="cov8" title="1">return result, nil</span>
        }

        <span class="cov8" title="1">result.DestSize = destInfo.Size()
        result.DestTime = destInfo.ModTime()

        // サイズの比較
        result.SizeMatch = sourceInfo.Size() == destInfo.Size()
        if !result.SizeMatch </span><span class="cov8" title="1">{
                result.Error = fmt.Errorf("ファイルサイズが一致しません (ソース: %d, 宛先: %d)", sourceInfo.Size(), destInfo.Size())

                // データベースに記録
                if v.db != nil </span><span class="cov0" title="0">{
                        fileInfo := database.FileInfo{
                                Path:         relPath,
                                Size:         sourceInfo.Size(),
                                ModTime:      sourceInfo.ModTime(),
                                Status:       database.StatusMismatch,
                                LastSyncTime: time.Now(),
                                LastError:    fmt.Sprintf("ファイルサイズが一致しません (ソース: %d, 宛先: %d)", sourceInfo.Size(), destInfo.Size()),
                        }
                        v.db.AddFile(fileInfo)
                }</span>

                <span class="cov8" title="1">return result, nil</span>
        }

        // ソースファイルのハッシュを計算
        <span class="cov8" title="1">sourceHash, err := v.hasher.HashFile(sourcePath)
        if err != nil </span><span class="cov0" title="0">{
                result.Error = fmt.Errorf("ソースファイルのハッシュ計算エラー: %w", err)

                // データベースに記録
                if v.db != nil </span><span class="cov0" title="0">{
                        fileInfo := database.FileInfo{
                                Path:         relPath,
                                Size:         sourceInfo.Size(),
                                ModTime:      sourceInfo.ModTime(),
                                Status:       database.StatusFailed,
                                LastSyncTime: time.Now(),
                                LastError:    fmt.Sprintf("ソースハッシュ計算エラー: %v", err),
                        }
                        v.db.AddFile(fileInfo)
                }</span>

                <span class="cov0" title="0">return result, nil</span>
        }

        <span class="cov8" title="1">result.SourceHash = sourceHash

        // 宛先ファイルのハッシュを計算
        destHash, err := v.hasher.HashFile(destPath)
        if err != nil </span><span class="cov0" title="0">{
                result.Error = fmt.Errorf("宛先ファイルのハッシュ計算エラー: %w", err)

                // データベースに記録
                if v.db != nil </span><span class="cov0" title="0">{
                        fileInfo := database.FileInfo{
                                Path:         relPath,
                                Size:         sourceInfo.Size(),
                                ModTime:      sourceInfo.ModTime(),
                                Status:       database.StatusFailed,
                                LastSyncTime: time.Now(),
                                LastError:    fmt.Sprintf("宛先ハッシュ計算エラー: %v", err),
                        }
                        v.db.AddFile(fileInfo)
                }</span>

                <span class="cov0" title="0">return result, nil</span>
        }

        <span class="cov8" title="1">result.DestHash = destHash

        // ハッシュ値をデータベースに記録
        if v.db != nil </span><span class="cov8" title="1">{
                v.db.UpdateFileHash(relPath, sourceHash, destHash)
        }</span>

        // ハッシュ値の比較
        <span class="cov8" title="1">result.HashMatch = sourceHash == destHash
        if !result.HashMatch </span><span class="cov8" title="1">{
                result.Error = fmt.Errorf("ハッシュ値が一致しません (ソース: %s, 宛先: %s)", sourceHash, destHash)

                // データベースに記録
                if v.db != nil </span><span class="cov0" title="0">{
                        fileInfo := database.FileInfo{
                                Path:         relPath,
                                Size:         sourceInfo.Size(),
                                ModTime:      sourceInfo.ModTime(),
                                Status:       database.StatusMismatch,
                                SourceHash:   sourceHash,
                                DestHash:     destHash,
                                LastSyncTime: time.Now(),
                                LastError:    "ハッシュ値が一致しません",
                        }
                        v.db.AddFile(fileInfo)
                }</span>

                <span class="cov8" title="1">return result, nil</span>
        }

        // 検証成功の記録
        <span class="cov8" title="1">if v.db != nil </span><span class="cov8" title="1">{
                fileInfo := database.FileInfo{
                        Path:         relPath,
                        Size:         sourceInfo.Size(),
                        ModTime:      sourceInfo.ModTime(),
                        Status:       database.StatusVerified,
                        SourceHash:   sourceHash,
                        DestHash:     destHash,
                        LastSyncTime: time.Now(),
                }
                v.db.AddFile(fileInfo)
        }</span>

        <span class="cov8" title="1">return result, nil</span>
}

// checkExtraFiles は宛先ディレクトリに余分なファイルがないかチェックする
func (v *Verifier) checkExtraFiles(sourceDir, destDir string) error <span class="cov8" title="1">{
        // 宛先ディレクトリを開く
        entries, err := os.ReadDir(destDir)
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("宛先ディレクトリ読み込みエラー: %w", err)
        }</span>

        // 各エントリの処理
        <span class="cov8" title="1">for _, entry := range entries </span><span class="cov8" title="1">{
                destPath := filepath.Join(destDir, entry.Name())
                sourcePath := filepath.Join(sourceDir, entry.Name())

                // ディレクトリの場合
                if entry.IsDir() </span><span class="cov8" title="1">{
                        if !v.options.Recursive </span><span class="cov0" title="0">{
                                continue</span>
                        }

                        // ソースディレクトリの存在確認
                        <span class="cov8" title="1">if _, err := os.Stat(sourcePath); os.IsNotExist(err) </span><span class="cov8" title="1">{
                                // 余分なディレクトリとして報告
                                result := VerificationResult{
                                        Path:         destPath,
                                        SourceExists: false,
                                        DestExists:   true,
                                        Error:        fmt.Errorf("余分なディレクトリが存在します"),
                                }
                                v.addResult(result)
                                continue</span>
                        }

                        // 再帰的にチェック
                        <span class="cov8" title="1">if err := v.checkExtraFiles(sourcePath, destPath); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                        <span class="cov8" title="1">continue</span>
                }

                // ファイルの場合
                <span class="cov8" title="1">info, err := entry.Info()
                if err != nil </span><span class="cov0" title="0">{
                        continue</span>
                }

                // ソースファイルの存在確認
                <span class="cov8" title="1">if _, err := os.Stat(sourcePath); os.IsNotExist(err) </span><span class="cov8" title="1">{
                        // フィルタリング
                        if v.filter != nil &amp;&amp; !v.filter.ShouldInclude(destPath) </span><span class="cov8" title="1">{
                                // ファイルをスキップ
                                continue</span>
                        }

                        // 余分なファイルとして報告
                        <span class="cov8" title="1">result := VerificationResult{
                                Path:         destPath,
                                SourceExists: false,
                                DestExists:   true,
                                DestSize:     info.Size(),
                                DestTime:     info.ModTime(),
                                Error:        fmt.Errorf("余分なファイルが存在します"),
                        }
                        v.addResult(result)

                        // データベースに記録
                        if v.db != nil </span><span class="cov0" title="0">{
                                relPath, _ := filepath.Rel(v.destDir, destPath)
                                fileInfo := database.FileInfo{
                                        Path:         relPath,
                                        Size:         info.Size(),
                                        ModTime:      info.ModTime(),
                                        Status:       database.StatusMismatch,
                                        LastSyncTime: time.Now(),
                                        LastError:    "ソースに存在しない余分なファイルです",
                                }
                                v.db.AddFile(fileInfo)
                        }</span>
                }
        }

        <span class="cov8" title="1">return nil</span>
}

// reportProgress は進捗報告を行うゴルーチン
func (v *Verifier) reportProgress() <span class="cov8" title="1">{
        ticker := time.NewTicker(v.options.ProgressInterval)
        defer ticker.Stop()

        var currentFile string
        var processedFiles int64

        for </span><span class="cov8" title="1">{
                select </span>{
                case &lt;-v.ctx.Done():<span class="cov0" title="0">
                        return</span>
                case file, ok := &lt;-v.progressChan:<span class="cov8" title="1">
                        if !ok </span><span class="cov8" title="1">{
                                return
                        }</span>
                        <span class="cov8" title="1">currentFile = file
                        processedFiles++</span>
                case &lt;-ticker.C:<span class="cov8" title="1">
                        if v.progressFunc != nil </span><span class="cov8" title="1">{
                                // 総ファイル数は不明なので、処理済みファイル数を報告
                                v.progressFunc(
                                        processedFiles,
                                        -1, // 総ファイル数不明
                                        currentFile,
                                )
                        }</span>
                }
        }
}

// GenerateReport は検証結果のレポートを生成する
func (v *Verifier) GenerateReport(reportPath string) error <span class="cov8" title="1">{
        // レポートディレクトリの作成
        reportDir := filepath.Dir(reportPath)
        if err := os.MkdirAll(reportDir, 0755); err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("レポートディレクトリの作成に失敗: %w", err)
        }</span>

        // ファイルを作成
        <span class="cov8" title="1">file, err := os.Create(reportPath)
        if err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("レポートファイル作成エラー: %w", err)
        }</span>
        <span class="cov8" title="1">defer file.Close()

        // ヘッダー行を書き込む
        _, err = file.WriteString("ファイルパス,ソース存在,宛先存在,サイズ一致,ハッシュ一致,ソースハッシュ,宛先ハッシュ,ソースサイズ,宛先サイズ,ソース更新日時,宛先更新日時,エラー\n")
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("ヘッダー書き込みエラー: %w", err)
        }</span>

        // 結果を書き込む
        <span class="cov8" title="1">for _, result := range v.results </span><span class="cov8" title="1">{
                // エラーメッセージの整形
                errorMsg := ""
                if result.Error != nil </span><span class="cov8" title="1">{
                        errorMsg = result.Error.Error()
                }</span>

                <span class="cov8" title="1">line := fmt.Sprintf(
                        "%s,%t,%t,%t,%t,%s,%s,%d,%d,%s,%s,%s\n",
                        result.Path,
                        result.SourceExists,
                        result.DestExists,
                        result.SizeMatch,
                        result.HashMatch,
                        result.SourceHash,
                        result.DestHash,
                        result.SourceSize,
                        result.DestSize,
                        result.SourceTime.Format(time.RFC3339),
                        result.DestTime.Format(time.RFC3339),
                        errorMsg,
                )
                _, err = file.WriteString(line)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("データ書き込みエラー: %w", err)
                }</span>
        }

        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
